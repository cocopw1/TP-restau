 <h1>Insertion numéro téléphone</h1>

    <div id="output">
        Veuillez renseigner votre numéro.
    </div>

    <div id="buttons">
        <button id="start-button">Commencer</button>
    </div>

    <script>
        // Les variables pour gérer l'état du jeu
        let phoneNumber = Array(10).fill(10); // L'équivalent de initialiser les 10 chiffres à 10
        let currentDigit = 0;
        let bottomLimit = 0;
        let topLimit = 9;
        let guess = 0;
        let stage = 'choix'; // Stages: 'choix', 'validation_initiale', 'correction'
        let originalDigit = -1; // Utilisé pour stocker le chiffre initial incorrect
        let messageSent = 0;
        let wrongIndex = randomInt(1, 9);
        let failedGuess = 0;
        
        // Références aux éléments HTML
        const outputElement = document.getElementById('output');
        const buttonsElement = document.getElementById('buttons');
        const bodyElement = document.body;
        
        // --- Fonctions utilitaires ---
        
        /** Génère un nombre aléatoire entre min (inclus) et max (inclus) */
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /** Affiche le numéro de téléphone actuel formaté */
        function formatPhoneNumber() {
            return phoneNumber.map(d => d === 10 ? '?' : d).join('');
        }

        /** Nettoie et configure les boutons pour un nouvel ensemble d'actions */
        function setButtons(actions) {
            buttonsElement.innerHTML = '';
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.label;
                button.onclick = action.handler;
                buttonsElement.appendChild(button);
            });
        }
        
        /** Vérifie un softlock et réinitialise si nécessaire */
        function checkSoftlock(handlerAfterReset) {
            if (bottomLimit > topLimit) {
                outputElement.innerHTML = "Tu t'es trompé, non? On recommence!";
                bottomLimit = 0;
                topLimit = 9;
                // Pause pour afficher le message, puis relance la logique
                setTimeout(handlerAfterReset, 1500);
                return true;
            }
            return false;
        }
        
        // --- Logique du jeu ---
        
        /** 1. Logique principale pour deviner les 10 chiffres */
        function startDigitGuessing() {
            if (currentDigit >= 10) {
                // Tous les chiffres ont été devinés
                injectWrongDigit();
                return;
            }
        
            // Réinitialisation pour la nouvelle tentative
            if (phoneNumber[currentDigit] !== 10) {
                currentDigit++;
                bottomLimit = 0;
                topLimit = 9;
                startDigitGuessing(); // Passe au chiffre suivant
                return;
            }
        
            // Génère une nouvelle supposition dans la plage [bottomLimit, topLimit]
            guess = randomInt(bottomLimit, topLimit);
            outputElement.innerHTML = `Est-ce que le chiffre en position ${currentDigit + 1} est ${guess}?`;
        
            setButtons([
                { label: "Oui", handler: () => handleChoice('oui') },
                { label: "Non, c'est trop bas", handler: () => handleChoice('plus_haut') },
                { label: "Non, c'est trop haut", handler: () => handleChoice('plus_bas') }
            ]);
        }
        
        /** Gère les clics de boutons lors du choix des digits */
        function handleChoice(action) {
            let nextAction = startDigitGuessing;
        
            if (action === 'oui') {
                phoneNumber[currentDigit] = guess;
                currentDigit++;
                bottomLimit = 0;
                topLimit = 9;
            } else if (action === 'plus_haut') {
                bottomLimit = guess + 1;
            } else if (action === 'plus_bas') {
                topLimit = guess - 1;
            }
        
            if (!checkSoftlock(nextAction)) {
                nextAction(); // Continue la logique
            }
        }
        
        
        /** 2. Insertion d'un digit incorrect (et début de la phase de validation) */
        function injectWrongDigit() {
            // Insertion d'un digit incorrect (pas le premier qui est forcément 0)
            //wrongIndex = randomInt(1, 9);
            let wrongValue = randomInt(0, 9);
    
            // S'assurer que la nouvelle valeur est différente de l'originale
            while (wrongValue === phoneNumber[wrongIndex]) {
                wrongValue = randomInt(0, 9);
            }
    
            originalDigit = phoneNumber[wrongIndex]; // stock
            phoneNumber[wrongIndex] = wrongValue;    // insertion du mauvais chiffre
            currentDigit = wrongIndex; // Utilisé dans la phase de correction

            stage = 'validation_initiale';
            outputElement.innerHTML = `Ton numéro est bien ${formatPhoneNumber()}?`;

            setButtons([
                { label: "Oui", handler: handleInitialValidationYes },
                { label: "Non", handler: startCorrectionPhase }
            ]);
        }
        
        /** Gère le bouton "Oui" lors de la validation initiale */
        function handleInitialValidationYes() {
            outputElement.innerHTML = outputElement.innerHTML + ' Es-tu sûr?';
            // Laisse les boutons figés ("ne laisse pas continuer")
            setButtons([
                { label: "Oui", handler: handleInitialValidationYes },
                { label: "Non", handler: startCorrectionPhase }
            ]);
        }


        /** 3. Phase de correction */
        function startCorrectionPhase() {
            stage = 'correction';
            //currentDigit = 0; // On commence par le premier chiffre pour la recherche de l'erreur
            bottomLimit = 0;
            topLimit = 9;
            
            // Réinitialise la mauvaise position pour la recherche
            //phoneNumber[currentDigit] = 10;
            findWrongDigit();
        }
        
        /** Étape 3a. Recherche du chiffre incorrect */
        function findWrongDigit() {
            if (phoneNumber[currentDigit] === originalDigit) {
                // Si la valeur est corrigée (ou si c'est la fin du jeu)
                return finalValidation();
            }
            
            let digitGuess = randomInt(0, 9); // Chiffre à vérifier la position
            
            // On doit s'assurer qu'on ne boucle pas sur la mauvaise position si elle est déjà corrigée, mais ici la logique est de *retrouver* l'erreur.
            // Votre prototype semble vouloir que la recherche se fasse aléatoirement sur la position (digitGuess)
            // tout en utilisant les limites [bottomLimit, topLimit] pour la position, ce qui est contradictoire.
            // J'adapte en utilisant [bottomLimit, topLimit] pour deviner la *position* du chiffre incorrect.
            
            digitGuess = randomInt(bottomLimit, topLimit);
            if (messageSent == 0) {
                outputElement.innerHTML = `Est-ce que le chiffre en position ${digitGuess + 1} est correct? (Numéro actuel: ${formatPhoneNumber()})`;
            }

            setButtons([
                { label: "Non", handler: () => handleDigitCorrection('non', digitGuess) },
                { label: "Oui, c'est un chiffre à gauche de celui-là qui est incorrect", handler: () => handleDigitCorrection('gauche', digitGuess) },
                { label: "Oui, c'est un chiffre à droite de celui-là qui est incorrect", handler: () => handleDigitCorrection('droite', digitGuess) }
            ]);
        }
        
        /** Gère les clics lors de la recherche du chiffre incorrect (3a) */
        function handleDigitCorrection(action, checkedPosition) {
            if (action === 'non') {
                // On a trouvé le chiffre incorrect (checkedPosition)
                if (checkedPosition==wrongIndex)
                {
                    currentDigit = checkedPosition; // C'est la position à corriger
                    bottomLimit = 0;
                    topLimit = 9;
                    guessTheValue(); // Passer à l'étape 3b
                    return;
                }
                else {
                    outputElement.innerHTML = outputElement.innerHTML + " Hmm, je crois que ce chiffre est correct...";
                    messageSent = messageSent + 1;
                    return;
                }
            } else if (action === 'gauche') {
                topLimit = checkedPosition - 1;
                messageSent = 0;
            } else if (action === 'droite') {
                bottomLimit = checkedPosition + 1;
                messageSent = 0;
            }
            
            if (!checkSoftlock(findWrongDigit)) {
                findWrongDigit(); // Continuer la recherche
            }
        }
        
        
        /** Étape 3b. Deviner la valeur du chiffre incorrect */
        function guessTheValue() {
            // On est sûr que currentDigit est la position à corriger
            guess = randomInt(bottomLimit, topLimit);
            if (failedGuess == 0) {
                outputElement.innerHTML = `Est-ce que le chiffre en position ${currentDigit + 1} est ${guess}?`;
            }
            else {
                outputElement.innerHTML = `Hmm, je ne crois pas... Est-ce que le chiffre en position ${currentDigit + 1} est ${guess}?`;
            }

        
            setButtons([
                { label: "Oui", handler: () => handleValueGuess('oui') },
                { label: "Non, c'est trop bas", handler: () => handleValueGuess('plus_haut') },
                { label: "Non, c'est trop haut", handler: () => handleValueGuess('plus_bas') }
            ]);
        }
        
        /** Gère les clics lors de la devinette de la valeur (3b) */
        function handleValueGuess(action) {
            if (action === 'oui') {
                // La correction est faite, on vérifie si la position d'origine est rétablie
                if (guess == originalDigit) {
                    phoneNumber[currentDigit] = guess;
                    finalValidation();
                } else {
                     // Si le joueur donne une autre mauvaise valeur, on revient à l'étape 3a pour retrouver l'erreur
                     //currentDigit = 0;
                     bottomLimit = 0;
                     topLimit = 9;
                     failedGuess = 1;
                     guessTheValue(); 
                }
                return;
            } else if (action === 'plus_haut') {
                bottomLimit = guess + 1;
            } else if (action === 'plus_bas') {
                topLimit = guess - 1;
            }
        
            if (!checkSoftlock(guessTheValue)) {
                guessTheValue(); // Continuer la devinette de valeur
            }
        }
        
        
        /** 4. Validation finale */
        function finalValidation() {
            outputElement.innerHTML = `Donc finalement, ton numéro est bien ${formatPhoneNumber()}?`;
            
            setButtons([
                { label: "Oui", handler: handleFinalValidationYes },
                { label: "Non", handler: handleFinalValidationNo }
            ]);
        }
        
        /** Gère le bouton "Oui" lors de la validation finale */
        function handleFinalValidationYes() {
            outputElement.innerHTML = "Super! Merci!";
            setButtons([]); // Fin du jeu
        }
        
        /** Gère le bouton "Non" lors de la validation finale */
        function handleFinalValidationNo() {
            // Mettre la page en noir et le texte en blanc
            bodyElement.classList.add('abandon-state');
            outputElement.innerHTML = "Bon j'abandonne. Au revoir."; // au milieu de l'écran
            setButtons([]); // Fin du jeu
        }
        
        // --- Initialisation ---

        // Ajout du listener sur le bouton "Commencer" initial
        document.getElementById('start-button').onclick = () => {
            currentDigit = 0; // On commence à deviner à partir du premier chiffre
            startDigitGuessing();
        }
    </script>
